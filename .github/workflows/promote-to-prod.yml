# .github/workflows/promote-to-prod.yml
name: Promote RC to Stable & Release

on:
  workflow_dispatch:
    inputs:
      rc_tag:
        description: 'RC tag to promote (e.g., v1.4.0-rc.3)'
        required: true
        type: string
      stable_tag:
        description: 'Stable tag (defaults to rc base, e.g., v1.4.0)'
        required: false
        type: string

permissions:
  contents: write
  id-token: write
  pull-requests: read

concurrency:
  group: promote-to-prod
  cancel-in-progress: false

jobs:
  promote:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ vars.AWS_REGION || 'ap-southeast-2' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve tags
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          RC="${{ inputs.rc_tag }}"
          if ! echo "$RC" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$'; then
            echo "::error::rc_tag must look like vX.Y.Z-rc.N"; exit 1
          fi

          BASE="${RC%-rc.*}"
          STABLE_INPUT="${{ inputs.stable_tag || '' }}"
          if [ -n "$STABLE_INPUT" ]; then
            STABLE="$STABLE_INPUT"
          else
            STABLE="$BASE"
          fi

          git fetch --tags --force
          SHA="$(git rev-list -n 1 "$RC")" || { echo "::error::RC tag not found in git."; exit 1; }

          if git rev-parse -q --verify "refs/tags/$STABLE" >/dev/null; then
            echo "::error::Stable tag '$STABLE' already exists."; exit 1
          fi

          echo "rc=$RC" >> "$GITHUB_OUTPUT"
          echo "stable=$STABLE" >> "$GITHUB_OUTPUT"
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure prod ECR repos (create if missing)
        shell: bash
        run: |
          set -euo pipefail
          REGION="${AWS_REGION}"

          ensure_repo () {
            local repo="$1"
            if ! aws ecr describe-repositories --repository-names "$repo" --region "$REGION" >/dev/null 2>&1; then
              echo "Creating ECR repo: $repo"
              aws ecr create-repository \
                --repository-name "$repo" \
                --region "$REGION" \
                --image-scanning-configuration scanOnPush=true \
                --image-tag-mutability MUTABLE >/dev/null
              aws ecr put-lifecycle-policy \
                --repository-name "$repo" \
                --lifecycle-policy-text '{
                  "rules":[
                    {
                      "rulePriority":1,
                      "description":"Expire untagged after 7 days",
                      "selection":{"tagStatus":"untagged","countType":"sinceImagePushed","countUnit":"days","countNumber":7},
                      "action":{"type":"expire"}
                    },
                    {
                      "rulePriority":10,
                      "description":"Keep last 20 gh-/v tags",
                      "selection":{"tagStatus":"tagged","tagPrefixList":["gh-","v"],"countType":"imageCountMoreThan","countNumber":20},
                      "action":{"type":"expire"}
                    }
                  ]
                }' >/dev/null || true
            else
              echo "ECR repo exists: $repo"
            fi
          }

          ensure_repo "sbeacon-prod-analytics-lambda-containers"
          ensure_repo "sbeacon-prod-askbeacon-lambda-containers"

      - name: ECR Login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Assert staging images exist
        shell: bash
        run: |
          set -euo pipefail
          RC="${{ steps.ver.outputs.rc }}"
          aws ecr describe-images --repository-name sbeacon-staging-analytics-lambda-containers \
            --image-ids imageTag="$RC" --query 'imageDetails[0].imageDigest' --output text
          aws ecr describe-images --repository-name sbeacon-staging-askbeacon-lambda-containers \
            --image-ids imageTag="$RC" --query 'imageDetails[0].imageDigest' --output text

      - name: Copy images STAGING -> PROD via pull/tag/push (no rebuild)
        id: copy
        shell: bash
        run: |
          set -euo pipefail
          RC="${{ steps.ver.outputs.rc }}"
          STABLE="${{ steps.ver.outputs.stable }}"

          ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text)
          REG="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

          copy_image () {
            local svc="$1"
            local SRC="${REG}/sbeacon-staging-${svc}-lambda-containers:${RC}"
            local DST="${REG}/sbeacon-prod-${svc}-lambda-containers:${STABLE}"

            echo "Pull  ${SRC}"
            docker pull "${SRC}"

            echo "Tag   ${SRC} -> ${DST}"
            docker tag "${SRC}" "${DST}"

            echo "Push  ${DST}"
            docker push "${DST}"
          }

          copy_image analytics
          copy_image askbeacon

          echo "registry=${REG}" >> "$GITHUB_OUTPUT"

      - name: Resolve PROD digests for the stable tag
        id: digests
        shell: bash
        run: |
          set -euo pipefail
          STABLE="${{ steps.ver.outputs.stable }}"
          ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text)
          REG="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

          get_digest () {
            local repo="$1"
            aws ecr describe-images \
              --repository-name "$repo" \
              --image-ids imageTag="$STABLE" \
              --query 'imageDetails[0].imageDigest' --output text
          }

          A_REPO="sbeacon-prod-analytics-lambda-containers"
          B_REPO="sbeacon-prod-askbeacon-lambda-containers"

          A_DIGEST="$(get_digest "$A_REPO")"
          B_DIGEST="$(get_digest "$B_REPO")"

          if [ -z "$A_DIGEST" ] || [ "$A_DIGEST" = "None" ]; then
            echo "::error::analytics image not found for tag $STABLE in PROD"; exit 1
          fi
          if [ -z "$B_DIGEST" ] || [ "$B_DIGEST" = "None" ]; then
            echo "::error::askbeacon image not found for tag $STABLE in PROD"; exit 1
          fi

          echo "registry=$REG"              >> "$GITHUB_OUTPUT"
          echo "analytics_digest=$A_DIGEST" >> "$GITHUB_OUTPUT"
          echo "askbeacon_digest=$B_DIGEST" >> "$GITHUB_OUTPUT"

      - name: Create stable Git tag pointing to RC commit
        run: |
          git config user.name  "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git tag -a "${{ steps.ver.outputs.stable }}" "${{ steps.ver.outputs.sha }}" \
            -m "Promote ${{ steps.ver.outputs.rc }} to ${{ steps.ver.outputs.stable }}"
          git push origin "${{ steps.ver.outputs.stable }}"

      - name: Create GitHub Release (stable)
        uses: softprops/action-gh-release@v2
        with:
          tag_name:  ${{ steps.ver.outputs.stable }}
          name:      ${{ steps.ver.outputs.stable }}
          prerelease: false
          make_latest: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post summary
        run: |
          echo "### Promoted \`${{ steps.ver.outputs.rc }}\` â†’ **${{ steps.ver.outputs.stable }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Registry: \`${{ steps.digests.outputs.registry }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Analytics: \`sbeacon-prod-analytics-lambda-containers@${{ steps.digests.outputs.analytics_digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- AskBeacon: \`sbeacon-prod-askbeacon-lambda-containers@${{ steps.digests.outputs.askbeacon_digest }}\`" >> $GITHUB_STEP_SUMMARY
