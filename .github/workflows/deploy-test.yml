name: Deploy Dev

on:
  push:
    branches:
      - develop
    paths:
      - '**/*.tf'
      - '**/*.tfvars'
      - 'lambda/**'
      - 'layers/**'
      - '.github/workflows/deploy-dev.yml'
  workflow_dispatch:

concurrency:
  group: terraform-dev
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

jobs:
  build-plan-and-apply:
    name: Build Docker & Deploy Terraform (Dev)
    runs-on: ubuntu-latest
    environment: dev
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      TF_WORKING_DIR: environments
      TF_WORKSPACE: dev
      TF_APPLY: ${{ github.event_name == 'push' }}
      TF_APPLY_DISPATCH: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.apply == 'true' }}
      TF_IN_AUTOMATION: true
      TF_INPUT: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install build toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool pkg-config zlib1g-dev libcurl4-openssl-dev

      - name: Run init script
        run: |
          chmod +x ./init.sh
          ./init.sh

      - name: Prepare analytics shared assets
        working-directory: lambda/analytics
        run: python docker_prep.py

      - name: Prepare askbeacon shared assets
        working-directory: lambda/askbeacon
        run: python docker_prep.py

      - name: Log in to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build analytics lambda image
        working-directory: lambda/analytics
        run: docker build -t ${{ steps.login-ecr.outputs.registry }}/sbeacon-analytics-lambda-containers:latest .

      - name: Build askbeacon lambda image
        working-directory: lambda/askbeacon
        run: docker build -t ${{ steps.login-ecr.outputs.registry }}/sbeacon-askbeacon-lambda-containers:latest .

      - name: Push analytics lambda image
        run: docker push ${{ steps.login-ecr.outputs.registry }}/sbeacon-analytics-lambda-containers:latest

      - name: Push askbeacon lambda image
        run: docker push ${{ steps.login-ecr.outputs.registry }}/sbeacon-askbeacon-lambda-containers:latest

      - name: Configure image digests for Terraform
        run: |
          analytics=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ steps.login-ecr.outputs.registry }}/sbeacon-analytics-lambda-containers:latest)
          askbeacon=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ steps.login-ecr.outputs.registry }}/sbeacon-askbeacon-lambda-containers:latest)
          echo "TF_VAR_analytics_lambda_image_uri=${analytics}" >> $GITHUB_ENV
          echo "TF_VAR_askbeacon_lambda_image_uri=${askbeacon}" >> $GITHUB_ENV

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend dependencies
        working-directory: ui
        run: npm ci

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.4

      - name: Terraform fmt
        run: terraform fmt -check -recursive

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -input=false -upgrade -backend-config=backend-dev.hcl

      - name: Select Terraform Workspace
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform workspace select ${{ env.TF_WORKSPACE }} || terraform workspace new ${{ env.TF_WORKSPACE }}

      - name: Terraform Validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan -input=false -out=tfplan
          terraform show -no-color tfplan > tfplan.txt

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: dev-terraform-plan-${{ github.run_id }}
          path: ${{ env.TF_WORKING_DIR }}/tfplan.txt

      - name: Terraform Apply
        if: env.TF_APPLY == 'true' || env.TF_APPLY_DISPATCH == 'true'
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform apply -input=false -auto-approve tfplan

      - name: Clean up plan
        if: always()
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: rm -f tfplan tfplan.txt

