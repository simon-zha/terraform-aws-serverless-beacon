name: Destroy Infrastructure
on:
  workflow_dispatch:  # Manual dispatch
    inputs:
      workspace:
        description: "Terraform workspace to destroy (dev/staging/prod)"  # Terraform workspace to destroy (development/staging/production)
        required: true  # Mandatory field
        default: "dev"  # Default value is dev
        type: choice  # Dropdown selection type
        options:
          - dev
          - staging
          - prod
      confirm_destroy:
        description: "Type 'DESTROY' to confirm deletion of all resources"  # Type 'DESTROY' to confirm deletion of all resources
        required: true  # Mandatory field
        type: string

permissions:
  contents: read  # Permission: Read repository contents
  id-token: write  # Permission: Write identity token (for AWS authentication)

jobs:
  destroy:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest  # Run on: Latest Ubuntu
    environment: ${{ inputs.workspace }}  # Associated GitHub environment (matches workspace)
    env:
      AWS_REGION: ${{ vars.AWS_REGION || 'ap-southeast-2' }}  # AWS region (use repo var or default to ap-southeast-2)
      TF_WORKING_DIR: environments  # Terraform working directory
      TARGET_WORKSPACE: ${{ inputs.workspace }}  # Target Terraform workspace
      TF_IN_AUTOMATION: true  # Mark as automated execution
      TF_INPUT: false  # Disable interactive input
      # Terraform variables (retrieved from GitHub Secrets or variables)
      TF_VAR_region: ${{ vars.AWS_REGION || 'ap-southeast-2' }}
      TF_VAR_beacon_admin_username: ${{ secrets.BEACON_ADMIN_USERNAME }}
      TF_VAR_beacon_admin_password: ${{ secrets.BEACON_ADMIN_PASSWORD }}
      TF_VAR_beacon_guest_username: ${{ secrets.BEACON_GUEST_USERNAME }}
      TF_VAR_beacon_guest_password: ${{ secrets.BEACON_GUEST_PASSWORD }}
      TF_VAR_azure_openai_api_key: ${{ secrets.AZURE_OPENAI_API_KEY }}
      TF_VAR_azure_openai_endpoint: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
      TF_VAR_azure_openai_api_version: ${{ secrets.AZURE_OPENAI_API_VERSION }}
      TF_VAR_azure_openai_chat_deployment_name: ${{ secrets.AZURE_OPENAI_CHAT_DEPLOYMENT_NAME }}
      TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
    steps:
      - name: Checkout  # Step 1: Check out the repository
        uses: actions/checkout@v4

      - name: Verify destroy confirmation  # Step 2: Verify destroy confirmation
        run: |
          # Exit with error if confirmation is not 'DESTROY'
          if [ "${{ inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "enter destroy"
            exit 1
          fi
          echo "destroy confirmed"  # Confirm destruction

      - name: Configure AWS credentials  # Step 3: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}  # AWS role ARN from Secrets
          aws-region: ${{ env.AWS_REGION }}  # Specified AWS region

      - name: Setup Terraform  # Step 4: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.4  # Specify Terraform version

      - name: Terraform Init  # Step 5: Terraform initialization
        run: |
          BACKEND_CONFIG="backend-${{ inputs.workspace }}.hcl"  # Backend config file for the workspace
          # Initialize Terraform with specified working directory, backend config, and upgrade plugins
          terraform -chdir=${{ env.TF_WORKING_DIR }} init -input=false -upgrade -backend-config="$BACKEND_CONFIG"

      - name: Select Terraform Workspace  # Step 6: Select Terraform workspace
        run: |
          # Select existing workspace, create new if not exists
          terraform -chdir=${{ env.TF_WORKING_DIR }} workspace select ${{ env.TARGET_WORKSPACE }} || terraform -chdir=${{ env.TF_WORKING_DIR }} workspace new ${{ env.TARGET_WORKSPACE }}

      - name: Terraform Refresh  # Step 7: Terraform state refresh
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} refresh -input=false

      - name: List Resources  # Step 8: List current resources
        run: |
          echo "Current resources list："
          # List resources in state, or echo message if failed
          terraform -chdir=${{ env.TF_WORKING_DIR }} state list || echo "can not get resources list"

      - name: Terraform Plan (Destroy)  # Step 9: Generate destroy plan
        run: |
          # Generate destroy plan and save to file
          terraform -chdir=${{ env.TF_WORKING_DIR }} plan -destroy -input=false -out=destroy-plan
          # Convert plan to text and save
          terraform -chdir=${{ env.TF_WORKING_DIR }} show -no-color destroy-plan > ${{ env.TF_WORKING_DIR }}/destroy-plan.txt

      - name: Upload Destroy Plan  # Step 10: Upload destroy plan file
        uses: actions/upload-artifact@v4
        with:
          name: destroy-plan-${{ inputs.workspace }}-${{ github.run_id }}  # Artifact name (includes workspace and run ID)
          path: ${{ env.TF_WORKING_DIR }}/destroy-plan.txt  # Path to the file to upload

      - name: Terraform Destroy  # Step 11: Execute Terraform destroy
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} apply -input=false -auto-approve destroy-plan

      - name: Clean up plan files  # Step 12: Clean up plan files (runs regardless of outcome)
        if: always()
        run: rm -f ${{ env.TF_WORKING_DIR }}/destroy-plan ${{ env.TF_WORKING_DIR }}/destroy-plan.txt

      - name: Verify Destruction  # Step 13: Verify destruction result
        run: |
          echo "validate if resources are completed destory"
          # Get list of resources in current state
          RESOURCES=$(terraform -chdir=${{ env.TF_WORKING_DIR }} state list 2>/dev/null || echo "")
          if [ -n "$RESOURCES" ]; then
            echo "Resources remain："
            echo "$RESOURCES"
            echo "Need manual cleanup"
          else
            echo "All resources are deleted!!!"
          fi
