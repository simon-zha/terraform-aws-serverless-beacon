# .github/workflows/deploy-staging.yml
name: Deploy Staging Environment

on:
  pull_request:
    branches:
      - 'release'
      - 'release/**'
    types: [ closed ]
  workflow_dispatch:
    inputs:
      apply:
        description: "Start terraform apply (true/false)"
        required: false
        default: "true"
      aws_region:
        description: "AWS Region (default: ap-southeast-2)"
        required: false
        default: "ap-southeast-2"
      backend_config:
        description: "Backend HCL file (default: backend-dev.hcl)"
        required: false
        default: "backend-dev.hcl"
      workspace:
        description: "Terraform workspace (default: staging)"
        required: false
        default: "staging"
      trigger_destroy:
        description: "Run terraform destroy after completion (true/false)"
        required: false
        default: "false"

permissions:
  contents: write
  id-token: write

concurrency:
  group: staging-release
  cancel-in-progress: true

jobs:
  deploy:
    name: Manual Terraform Deploy
    runs-on: ubuntu-latest
    environment: staging

    env:
      AWS_REGION: ${{ inputs.aws_region != '' && inputs.aws_region || vars.AWS_REGION || 'ap-southeast-2' }}
      TF_WORKING_DIR: ${{ github.workspace }}/environments
      TARGET_WORKSPACE: ${{ inputs.workspace != '' && inputs.workspace || 'staging' }}
      TF_APPLY_FLAG: ${{ inputs.apply != '' && inputs.apply || 'true' }}
      TF_DESTROY_FLAG: ${{ inputs.trigger_destroy != '' && inputs.trigger_destroy || 'false' }}
      TF_BACKEND_CONFIG: ${{ inputs.backend_config != '' && inputs.backend_config || 'backend-dev.hcl' }}
      TF_IN_AUTOMATION: true
      TF_INPUT: false

      TF_VAR_region: ${{ inputs.aws_region != '' && inputs.aws_region || vars.AWS_REGION || 'ap-southeast-2' }}
      TF_VAR_beacon_admin_username: ${{ secrets.BEACON_ADMIN_USERNAME }}
      TF_VAR_beacon_admin_password: ${{ secrets.BEACON_ADMIN_PASSWORD }}
      TF_VAR_beacon_guest_username: ${{ secrets.BEACON_GUEST_USERNAME }}
      TF_VAR_beacon_guest_password: ${{ secrets.BEACON_GUEST_PASSWORD }}
      TF_VAR_azure_openai_api_key: ${{ secrets.AZURE_OPENAI_API_KEY }}
      TF_VAR_azure_openai_endpoint: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
      TF_VAR_azure_openai_api_version: ${{ secrets.AZURE_OPENAI_API_VERSION }}
      TF_VAR_azure_openai_chat_deployment_name: ${{ secrets.AZURE_OPENAI_CHAT_DEPLOYMENT_NAME }}
      TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.4

      - name: Terraform Init
        run: |
          terraform -chdir=${{ env.TF_WORKING_DIR }} init \
            -input=false -upgrade \
            -backend-config=${{ env.TF_BACKEND_CONFIG }}

      - name: Select/Create Workspace
        run: |
          terraform -chdir=${{ env.TF_WORKING_DIR }} workspace select ${{ env.TARGET_WORKSPACE }} \
            || terraform -chdir=${{ env.TF_WORKING_DIR }} workspace new ${{ env.TARGET_WORKSPACE }}

      - name: Terraform Validate
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} validate

      - name: Terraform Plan
        id: plan
        run: |
          terraform -chdir=${{ env.TF_WORKING_DIR }} plan -input=false -out=tfplan
          terraform -chdir=${{ env.TF_WORKING_DIR }} show -no-color tfplan > ${{ env.TF_WORKING_DIR }}/tfplan.txt

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: manual-terraform-plan-${{ github.run_id }}
          path: ${{ env.TF_WORKING_DIR }}/tfplan.txt

      # ==== 合并到 release 时：打预发布 tag ====
      - name: Compute prerelease tag (rc)
        if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force
          LATEST="$(git describe --tags --abbrev=0 2>/dev/null || echo 'v0.0.0')"
          TITLE="${{ github.event.pull_request.title || '' }}"
          if echo "$TITLE" | grep -qiE 'BREAKING CHANGE|feat!'; then BUMP=major;
          elif echo "$TITLE" | grep -qiE '^feat(\(|: )'; then BUMP=minor;
          else BUMP=patch; fi
          BASE="${LATEST%%-*}"
          IFS='.' read -r MA MI PA <<<"${BASE#v}"
          case "$BUMP" in
            major) MA=$((MA+1)); MI=0; PA=0;;
            minor) MI=$((MI+1)); PA=0;;
            patch) PA=$((PA+1));;
          esac
          BASE="v${MA}.${MI}.${PA}"
          LAST_RC=$(git tag -l "${BASE}-rc.*" | sed -E 's/.*-rc\.([0-9]+)$/\1/' | sort -n | tail -1)
          if [ -z "$LAST_RC" ]; then N=1; else N=$((LAST_RC+1)); fi
          NEXT="${BASE}-rc.${N}"
          echo "next=$NEXT" >> "$GITHUB_OUTPUT"
          echo "NEXT=$NEXT"

      - name: Create & push tag
        if: steps.ver.outputs.next != ''
        run: |
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git tag -a "${{ steps.ver.outputs.next }}" -m "staging: ${GITHUB_SHA} via PR #${{ github.event.pull_request.number || '' }}"
          git push origin "${{ steps.ver.outputs.next }}"

      - name: Terraform Apply
        if: env.TF_APPLY_FLAG == 'true'
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} apply -input=false -auto-approve tfplan

      - name: Terraform Destroy
        if: env.TF_DESTROY_FLAG == 'true'
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} destroy -input=false -auto-approve

      - name: Clean up plan files
        if: always()
        run: rm -f ${{ env.TF_WORKING_DIR }}/tfplan ${{ env.TF_WORKING_DIR }}/tfplan.txt ${{ env.TF_WORKING_DIR }}/tfplan-updated
