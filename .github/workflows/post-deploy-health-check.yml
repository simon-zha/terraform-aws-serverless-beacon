# .github/workflows/post-deploy-health-check.yml
name: post-deploy-health-check
on:
  workflow_run:  # Trigger: Triggered after other workflows complete
    workflows:
      - deploy-dev  # Trigger source 1: Dev environment deployment workflow
      - deploy-staging  # Trigger source 2: Staging environment deployment workflow
      - deploy_prod  # Trigger source 3: Production environment deployment workflow
      - deploy-hotfix  # Trigger source 4: Hotfix deployment workflow
    types:
      - completed  # Execute only when the triggering workflow completes

# Permission configuration: GitHub permissions required for the workflow
permissions:
  contents: read  # Read repository contents (to access health check script)
  actions: read  # Read workflow-related information
  id-token: write  # Write identity token (for AWS authentication)
  issues: write  # Create GitHub Issues (on health check failure)

jobs:
  health:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}  # Execute only if triggering workflow succeeds
    runs-on: ubuntu-latest  # Run environment: Latest Ubuntu system
    steps:
      # Step 1: Determine target workspace information (match based on triggering deployment workflow)
      - name: Determine target workspace
        id: target  # Step ID for referencing outputs in subsequent steps
        run: |
          set -euo pipefail  # Strict script mode: exit on error
          workflow="${{ github.event.workflow.name }}"  # Get name of triggering workflow
          branch="${{ github.event.workflow_run.head_branch }}"  # Get branch of triggering workflow
          # Match environment info based on triggering workflow name
          case "${workflow}" in
            "deploy-dev")
              env_name="dev"  # Environment name: Development
              workspace="dev"  # Terraform workspace: dev
              backend="backend-dev.hcl"  # Backend config file: Dev environment
              ;;
            "deploy-staging")
              env_name="staging"
              workspace="staging"
              backend="backend-staging.hcl"  # Backend config file: Staging environment
              ;;
            "deploy_prod")
              env_name="prod"
              workspace="prod"
              backend="backend-prod.hcl"  # Backend config file: Production environment
              ;;
            "deploy-hotfix")
              env_name="hotfix"  # Environment name: Hotfix
              # Normalize branch name as workspace (use workflow ID if no branch)
              if [ -n "${branch}" ]; then
                normalized=$(echo "${branch}" | tr '[:upper:]' '[:lower:]' | sed -E 's#[^a-z0-9-]#-#g' | sed -E 's#-+#-#g' | sed -E 's#(^-|-$)##g')
              else
                normalized="hotfix-${{ github.event.workflow_run.id }}"
              fi
              workspace="${normalized}"  # Terraform workspace: Normalized name
              backend="backend-staging.hcl"  # Backend config file: Reuse staging
              ;;
            *)
              echo "::error::Unknown workflow ${workflow}"
              exit 1
              ;;
          esac
          # Output environment, workspace, and backend config to env variables
          echo "environment=${env_name}" >> "$GITHUB_OUTPUT"
          echo "workspace=${workspace}" >> "$GITHUB_OUTPUT"
          echo "backend=${backend}" >> "$GITHUB_OUTPUT"

      # Step 2: Check out repository (to access health check script and Terraform files)
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 3: Set up Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.4

      # Step 4: Set up Python environment
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # Step 5: Configure AWS credentials (for SSM parameter and Terraform state access)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}  # AWS role ARN from GitHub Secrets
          aws-region: ${{ vars.AWS_REGION || 'ap-southeast-2' }}  # AWS region (repo var first, default to Sydney)

      # Step 6: Resolve API URL from AWS SSM Parameter Store
      - name: Resolve API URL
        id: url  # Step ID for referencing API URL in subsequent steps
        run: |
          set -euo pipefail
          workspace="${{ steps.target.outputs.workspace }}"
          # Build SSM parameter name
