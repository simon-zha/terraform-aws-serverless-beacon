name: API Health Check

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to check (dev/staging/prod/all)"
        required: false
        default: "all"
      expected_status:
        description: "Expected HTTP status code"
        required: false
        default: "200"
      retries:
        description: "Maximum number of retries"
        required: false
        default: "6"
      timeout:
        description: "Timeout for single request (seconds)"
        required: false
        default: "8"
      backoff:
        description: "Exponential backoff multiplier"
        required: false
        default: "2"
  schedule:
    - cron: "20 * * * *"

permissions:
  contents: read
  actions: read
  id-token: write
  issues: write

jobs:
  health-check:
    name: Check ${{ matrix.environment_name }} API
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - environment_name: dev
            github_environment: dev
            workspace: dev
            backend_config: backend-dev.hcl
          - environment_name: staging
            github_environment: staging
            workspace: staging
            backend_config: backend-staging.hcl
          - environment_name: prod
            github_environment: prod
            workspace: prod
            backend_config: backend-prod.hcl
    environment: ${{ matrix.github_environment }}
    env:
      ENV_NAME: ${{ matrix.environment_name }}
      WORKSPACE: ${{ matrix.workspace }}
      BACKEND_CONFIG: ${{ matrix.backend_config }}
      AWS_REGION: ${{ vars.AWS_REGION || 'ap-southeast-2' }}
      EXPECTED_STATUS: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.expected_status) || '200' }}
      RETRIES: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.retries) || '6' }}
      TIMEOUT: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.timeout) || '8' }}
      BACKOFF: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.backoff) || '2' }}
    steps:
      - name: Decide execution
        id: gate
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            target="${{ github.event.inputs.environment }}"
            if [ "$target" != "all" ] && [ "$target" != "${ENV_NAME}" ]; then
              echo "run=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi
          echo "run=true" >> "$GITHUB_OUTPUT"

      - name: Skip summary
        if: steps.gate.outputs.run != 'true'
        run: |
          {
            echo "### [SKIP] - ${ENV_NAME}"
            echo "- Reason: Not within the scope of this execution"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Checkout repository
        if: steps.gate.outputs.run == 'true'
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        if: steps.gate.outputs.run == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        if: steps.gate.outputs.run == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.4

      - name: Prepare Terraform cache
        if: steps.gate.outputs.run == 'true'
        run: |
          echo "TF_PLUGIN_CACHE_DIR=$HOME/.terraform.d/plugin-cache" >> $GITHUB_ENV
          mkdir -p "$HOME/.terraform.d/plugin-cache"

      - name: Resolve API info from Terraform state
        if: steps.gate.outputs.run == 'true'
        id: tf_outputs
        run: |
          set -euo pipefail
          TF_DIR="${{ github.workspace }}/environments"
          terraform -chdir="$TF_DIR" init -input=false -backend-config="${BACKEND_CONFIG}" -reconfigure
          terraform -chdir="$TF_DIR" workspace select "${WORKSPACE}" >/dev/null 2>&1 || terraform -chdir="$TF_DIR" workspace new "${WORKSPACE}"
          api_url=$(terraform -chdir="$TF_DIR" output -raw api_url)
          echo "API_URL=${api_url}" >> $GITHUB_ENV
          admin_cmd=$(terraform -chdir="$TF_DIR" output -raw admin_login_command || echo "N/A")
          echo "ADMIN_CMD=${admin_cmd}" >> $GITHUB_ENV

      - name: Fetch bearer token (if available)
        if: steps.gate.outputs.run == 'true'
        run: |
          set -euo pipefail
          if [ "${ADMIN_CMD}" != "N/A" ] && [ -n "${ADMIN_CMD}" ]; then
            token=$(eval "${ADMIN_CMD}" | tr -d '"')
            if [ -n "${token}" ]; then
              echo "::add-mask::${token}"
              echo "BEARER_TOKEN=${token}" >> $GITHUB_ENV
            fi
          fi

      - name: Set up Python
        if: steps.gate.outputs.run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run health check
        if: steps.gate.outputs.run == 'true'
        id: health
        continue-on-error: true
        run: |
          set -euo pipefail
          extra=()
          if [ -n "${BEARER_TOKEN:-}" ]; then
            extra+=(--bearer-token "${BEARER_TOKEN}")
          fi
          python scripts/health_check.py \
            --url "${API_URL}" \
            --expected-status "${EXPECTED_STATUS}" \
            --retries "${RETRIES}" \
            --timeout "${TIMEOUT}" \
            --backoff "${BACKOFF}" \
            "${extra[@]}"

      - name: Report failure via issue
        if: steps.gate.outputs.run == 'true' && steps.health.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const envName = '${{ matrix.environment_name }}';
            const apiUrl = process.env.API_URL;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const title = `API Health Check failed: ${envName}`;
            const body = [
              `Environment: **${envName}**`,
              `URL: ${apiUrl}`,
              `Workflow run: ${runUrl}`,
              '',
              'Please verify API availability.'
            ].join('\n');
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100,
              labels: 'health-check'
            });
            const existing = issues.find(issue => issue.title === title);
            if (existing) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body: `Health check failed again. Details: ${runUrl}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['health-check','automated']
              });
            }
            core.setFailed(`Health check failed for ${envName}`);

      - name: Append result to summary
        if: steps.gate.outputs.run == 'true'
        run: |
          status="${{ steps.health.outcome }}"
          if [ "$status" = "success" ]; then
            prefix="[PASS]"
          else
            prefix="[FAIL]"
          fi
          {
            echo "### ${prefix} - ${ENV_NAME}"
            echo "- URL: ${API_URL}"
            echo "- Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          } >> "$GITHUB_STEP_SUMMARY"
